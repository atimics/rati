FROM node:20-alpine

# Install build dependencies
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    git \
    bash

# Install pnpm and set up global directory
RUN corepack enable && corepack prepare pnpm@latest --activate
# Set SHELL for pnpm setup
ENV SHELL=/bin/sh
RUN mkdir -p /root/.local/share/pnpm
ENV PNPM_HOME="/root/.local/share/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

# Install global tools
RUN pnpm add -g typescript tsx

WORKDIR /workspace

# Copy package files first for better caching
COPY package.json ./
COPY scripts/package.json ./scripts/
COPY web-frame/package.json ./web-frame/

# Install dependencies
RUN pnpm install

# Copy source files
COPY . .

# Build TypeScript
RUN pnpm build

EXPOSE 5173

CMD ["sleep", "infinity"]