FROM node:20-alpine

# Install minimal build dependencies
RUN apk add --no-cache python3 make g++ git bash

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /workspace

# Copy only essential files first
COPY package.json pnpm-workspace.yaml ./

# Create directory structure
RUN mkdir -p scripts web-frame

# Copy workspace package.json files
COPY scripts/package.json ./scripts/
COPY web-frame/package.json ./web-frame/

# Install with reduced concurrency to avoid memory issues
ENV PNPM_WORKER_CONCURRENCY=1
RUN pnpm install --no-frozen-lockfile || echo "Some dependencies may have failed"

# Copy source files
COPY . .

EXPOSE 5173

CMD ["sleep", "infinity"]